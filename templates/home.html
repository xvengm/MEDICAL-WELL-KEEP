<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Medical Report Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    .progress-bar { transition: width 0.2s ease; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-10 max-w-4xl">
    <div class="bg-white rounded-2xl shadow p-6 md:p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 mb-4">
          <i class="fa-solid fa-file-medical text-blue-600 text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">Upload your medical document</h1>
        <p class="text-gray-600 mt-1">We’ll summarize it in plain English with key findings and next steps.</p>
      </div>

      <!-- Upload -->
      <form id="uploadForm" class="space-y-6">
        <label
          for="fileInput"
          class="block cursor-pointer border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400"
        >
          <div class="flex flex-col items-center">
            <i class="fa-solid fa-cloud-arrow-up text-4xl text-blue-500 mb-3"></i>
            <p class="text-lg font-medium text-gray-700">Drag & drop or click to choose a file</p>
            <p class="text-sm text-gray-500 mt-1">PDF, DOC, DOCX, TXT, JPG, JPEG, PNG</p>
          </div>
          <input id="fileInput" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" />
        </label>

        <div id="fileMeta" class="hidden text-sm text-gray-700">
          <i class="fa-solid fa-file-lines mr-1"></i>
          <span id="fileName"></span>
          <button id="clearBtn" type="button" class="ml-2 text-red-600 hover:underline">Clear</button>
        </div>

        <div id="fileError" class="hidden text-sm text-red-600"></div>

        <!-- Progress -->
        <div id="progressWrap" class="hidden">
          <div class="flex justify-between text-sm mb-1">
            <span class="text-blue-700">Uploading…</span>
            <span id="progressPct" class="text-blue-700">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>

        <button
          id="submitBtn"
          type="submit"
          class="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold disabled:opacity-50"
          disabled
        >
          <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
          Upload & Summarize
        </button>

        <!-- Messages -->
        <div id="alertOk" class="hidden p-3 rounded-lg bg-green-50 text-green-800 text-sm"></div>
        <div id="alertErr" class="hidden p-3 rounded-lg bg-red-50 text-red-800 text-sm"></div>
      </form>

      <!-- Results -->
      <div id="results" class="hidden mt-10">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">Summary</h2>
          <span id="confidenceBadge" class="text-xs font-semibold px-2.5 py-1 rounded-full bg-gray-100 text-gray-700">Confidence</span>
        </div>
        <div class="prose max-w-none">
          <p id="summaryText" class="text-gray-800 whitespace-pre-line"></p>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">Main issue</h3>
            <p id="mainIssue" class="text-gray-700 text-sm whitespace-pre-line"></p>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">Treatment / Plan</h3>
            <p id="treatmentPlan" class="text-gray-700 text-sm whitespace-pre-line"></p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">Key findings</h3>
            <p id="keyFindings" class="text-gray-700 text-sm whitespace-pre-line"></p>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">Important notes</h3>
            <p id="importantNotes" class="text-gray-700 text-sm whitespace-pre-line"></p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">Codes</h3>
            <ul id="codesList" class="list-disc list-inside text-sm text-gray-700"></ul>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 border">
            <h3 class="font-semibold text-gray-800 mb-2">Follow-up questions</h3>
            <ul id="followupsList" class="list-disc list-inside text-sm text-gray-700"></ul>
          </div>
        </div>

        <div class="mt-6 bg-yellow-50 border border-yellow-100 rounded-lg p-4">
          <h3 class="font-semibold text-yellow-800 mb-1">Disclaimer</h3>
          <p id="disclaimer" class="text-sm text-yellow-900"></p>
          <h4 class="font-medium text-yellow-800 mt-3">Limitations</h4>
          <ul id="limitsList" class="list-disc list-inside text-sm text-yellow-900"></ul>
        </div>

        <!-- Follow-up ask -->
        <div class="mt-8 border-t pt-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Ask a follow-up question</h3>
          <div class="flex gap-2">
            <input id="askInput" type="text" class="flex-1 border rounded-lg px-3 py-2" placeholder="e.g., What does ‘high parasitemia’ mean?" />
            <button id="askBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold disabled:opacity-50" disabled>
              Ask
            </button>
          </div>
          <div id="askError" class="hidden text-sm text-red-600 mt-2"></div>
        </div>

        <!-- Follow-up answer -->
        <div id="askResultCard" class="hidden mt-6 bg-white border rounded-xl p-4 shadow-sm">
          <h4 class="font-semibold text-gray-800 mb-2">Answer</h4>
          <p id="askSummary" class="text-gray-800 text-sm whitespace-pre-line"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const allowed = ['.pdf','.doc','.docx','.txt','.jpg','.jpeg','.png'];

    const fileInput      = document.getElementById('fileInput');
    const fileMeta       = document.getElementById('fileMeta');
    const fileNameSpan   = document.getElementById('fileName');
    const clearBtn       = document.getElementById('clearBtn');
    const fileError      = document.getElementById('fileError');
    const progressWrap   = document.getElementById('progressWrap');
    const progressBar    = document.getElementById('progressBar');
    const progressPct    = document.getElementById('progressPct');
    const submitBtn      = document.getElementById('submitBtn');
    const alertOk        = document.getElementById('alertOk');
    const alertErr       = document.getElementById('alertErr');

    const results        = document.getElementById('results');
    const confidenceBadge= document.getElementById('confidenceBadge');
    const summaryText    = document.getElementById('summaryText');
    const mainIssue      = document.getElementById('mainIssue');
    const treatmentPlan  = document.getElementById('treatmentPlan');
    const keyFindings    = document.getElementById('keyFindings');
    const importantNotes = document.getElementById('importantNotes');
    const codesList      = document.getElementById('codesList');
    const followupsList  = document.getElementById('followupsList');
    const disclaimer     = document.getElementById('disclaimer');
    const limitsList     = document.getElementById('limitsList');

    const askInput       = document.getElementById('askInput');
    const askBtn         = document.getElementById('askBtn');
    const askError       = document.getElementById('askError');
    const askResultCard  = document.getElementById('askResultCard');
    const askSummary     = document.getElementById('askSummary');

    let sessionId = null;

    fileInput.addEventListener('change', () => {
      fileError.classList.add('hidden');
      alertOk.classList.add('hidden');
      alertErr.classList.add('hidden');
      const file = fileInput.files[0];
      if (!file) {
        fileMeta.classList.add('hidden');
        submitBtn.disabled = true;
        return;
      }
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      if (!allowed.includes(ext)) {
        fileError.textContent = `Unsupported file type ${ext}.`;
        fileError.classList.remove('hidden');
        submitBtn.disabled = true;
        return;
      }
      fileNameSpan.textContent = file.name;
      fileMeta.classList.remove('hidden');
      submitBtn.disabled = false;
    });

    clearBtn.addEventListener('click', () => {
      fileInput.value = '';
      fileMeta.classList.add('hidden');
      submitBtn.disabled = true;
      fileError.classList.add('hidden');
    });

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) return;

      results.classList.add('hidden');
      alertOk.classList.add('hidden');
      alertErr.classList.add('hidden');
      progressWrap.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressPct.textContent = '0%';

      try {
        const res = await uploadWithProgress('/api/upload', file, (pct) => {
          progressBar.style.width = pct + '%';
          progressPct.textContent = pct + '%';
        });

        progressWrap.classList.add('hidden');

        if (!res.ok) {
          const err = await res.json();
          alertErr.textContent = err.detail || 'Upload failed.';
          alertErr.classList.remove('hidden');
          return;
        }

        const data = await res.json();
        sessionId = data.session_id || null;
        askBtn.disabled = !sessionId;

        renderResult(data);

        fileInput.value = '';
        fileMeta.classList.add('hidden');
        submitBtn.disabled = true;
        alertOk.textContent = 'Document processed successfully.';
        alertOk.classList.remove('hidden');
      } catch (err) {
        progressWrap.classList.add('hidden');
        alertErr.textContent = 'Network error. Please try again.';
        alertErr.classList.remove('hidden');
      }
    });

    askBtn.addEventListener('click', async () => {
      askError.classList.add('hidden');
      askResultCard.classList.add('hidden');
      const q = (askInput.value || '').trim();
      if (!sessionId) {
        askError.textContent = 'No session. Upload a document first.';
        askError.classList.remove('hidden');
        return;
      }
      if (q.length < 3) {
        askError.textContent = 'Please type a longer question.';
        askError.classList.remove('hidden');
        return;
      }
      askBtn.disabled = true;
      try {
        const resp = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, question: q })
        });
        const data = await resp.json();
        if (!resp.ok) {
          askError.textContent = data.detail || 'Failed to get an answer.';
          askError.classList.remove('hidden');
        } else {
          askSummary.textContent = data.summary || '';
          askResultCard.classList.remove('hidden');
        }
      } catch (e) {
        askError.textContent = 'Network error.';
        askError.classList.remove('hidden');
      } finally {
        askBtn.disabled = false;
      }
    });

    // XHR-based upload with progress
    function uploadWithProgress(url, file, onProgress) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url);

        xhr.responseType = 'json';
        xhr.onload = () => resolve({
          ok: xhr.status >= 200 && xhr.status < 300,
          status: xhr.status,
          json: () => Promise.resolve(xhr.response)
        });
        xhr.onerror = () => reject(new Error('Network error'));

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable && typeof onProgress === 'function') {
            onProgress(Math.round((e.loaded / e.total) * 100));
          }
        };

        const formData = new FormData();
        formData.append('file', file);
        xhr.send(formData);
      });
    }

    function renderResult(d) {
      results.classList.remove('hidden');

      summaryText.textContent   = d.summary || '';
      mainIssue.textContent     = d.main_issue || '';
      treatmentPlan.textContent = d.treatment_plan || '';
      keyFindings.textContent   = d.key_findings || '';
      importantNotes.textContent= d.important_notes || '';
      disclaimer.textContent    = d.disclaimer || '';

      confidenceBadge.textContent = `Confidence: ${d.confidence || 'N/A'}`;
      confidenceBadge.className = 'text-xs font-semibold px-2.5 py-1 rounded-full';
      const c = (d.confidence || '').toLowerCase();
      if (c.includes('high')) {
        confidenceBadge.classList.add('bg-green-100','text-green-800');
      } else if (c.includes('medium')) {
        confidenceBadge.classList.add('bg-yellow-100','text-yellow-800');
      } else if (c.includes('low')) {
        confidenceBadge.classList.add('bg-red-100','text-red-800');
      } else {
        confidenceBadge.classList.add('bg-gray-100','text-gray-700');
      }

      // Lists
      codesList.innerHTML = '';
      (d.codes || []).forEach(code => {
        const li = document.createElement('li'); li.textContent = code; codesList.appendChild(li);
      });

      followupsList.innerHTML = '';
      (d.follow_up_questions || []).forEach(q => {
        const li = document.createElement('li'); li.textContent = q; followupsList.appendChild(li);
      });

      limitsList.innerHTML = '';
      (d.limitations || []).forEach(l => {
        const li = document.createElement('li'); li.textContent = l; limitsList.appendChild(li);
      });
    }
  </script>
</body>
</html>

